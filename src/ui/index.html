<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>Inspark scheme and plan Editor</title>
  <link href="https://static.figma.com/api/figma-extension-api-0.0.1.css" rel="stylesheet">
  <style>
    .d-none {
      display: none;
    }

    .grid {
      display: flex;
      flex-direction: row;
    }

    .grid_wrap {
      flex-wrap: wrap;
    }

    .grid__cell_width-50 {
      flex-basis: 50%;
      flex-grow: 0;
    }

    .input-text {
      min-width: 0;
      width: 100%;
      flex-grow: 0;
    }


    .grid-container {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      padding: 0;
      justify-items: stretch;
      align-items: stretch;
    }

    .grid-item {
      display: flex;
      align-items: center;
      justify-content: center;
      /*height: 96px;*/
      height: auto;
      flex-direction: row;
      gap: 8px;
      padding: 0;
      opacity: 1;
    }

    .grid-item_locker-cell {
      position: relative;
      border: 1px solid #eee;
      padding: 16px 8px;
      font-weight: bold;
    }

    .grid-item_locker-cell:after {
      content: '‚úèÔ∏è';
      position: absolute;
      top: 0;
      right: 0;
      visibility: hidden;
    }

    .grid-item_locker-cell:hover,
    .grid-item_locker-cell:focus {
      border-color: #0B99FF;
      cursor: pointer;

      .grid-item_locker-cell:after {
        visibility: visible;
      }
    }

    .grid-item_locker-cell:hover:after {
      visibility: visible;
    }

    .cell-label {
      min-width: 16px;
      text-align: right;
    }

    form {
      margin: 0;
    }

    .form-group {
      display: flex;
      margin-bottom: 8px;
      align-items: center;
    }

    .form-group_block {
      flex-direction: column;
      align-items: normal;
    }

    .setup__device {
      display: flex;
      align-items: center;
      gap: 4px;
      margin-bottom: 16px;
    }

    .locker-index {
      position: absolute;
      left: 4px;
      top: 4px;
      font-size: 9px;
      font-weight: normal;
      opacity: 0.75;
    }

    .dialog {
      padding: 0;
      border: 1px solid transparent;
      border-radius: 3px;
      box-shadow: 0px 0px .5px rgba(0, 0, 0, .08), 0px 10px 24px rgba(0, 0, 0, .18), 0px 2px 5px rgba(0, 0, 0, .15);
    }

    .dialog__header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 4px;
      gap: 4px;
    }

    .btn-close {
      border: none;
      margin-right: -4px;
    }

    .header-title {
      font-size: 12px;
      font-weight: bold;
    }

    .dialog__body {
      padding: 4px;
    }
  </style>
</head>
<body>
<div class="d-none" id="setup">
  <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Å—Ö–µ–º—ã/–ø–ª–∞–Ω–∞</h2>
  <div class="grid">
    <div class="grid__cell">
      <div class="setup" id="deviceFormTemplate">
        <div class="setup__device" id="setupDevice">
          <svg height="24" viewBox="0 0 24 24"
               width="24"
               xmlns="http://www.w3.org/2000/svg">
            <use xlink:href="#locker"></use>
          </svg>
          <span id="deviceInfo" style="font-weight: bold;"></span>
        </div>
        <div class="setup__form">
          <div id="lockerForm">
            <dialog class="dialog" id="cellEditDialog">
              <header class="dialog__header">
                <div class="header-title" id="dialogTitle">

                </div>
                <button aria-label="close" class="btn-close" formnovalidate id="dialogCloseBtn">‚úñ</button>
              </header>
              <div class="dialog__body">
                <form method="dialog">
                  <div class="form-group form-group_block">
                    <label for="lockerCellNumberInput">–ù–æ–º–µ—Ä —è—á–µ–π–∫–∏</label>
                    <input id="lockerCellNumberInput" type="number">
                  </div>
                  <div class="form-group">
                    <input id="lockerCellNumberCheckbox" type="checkbox">
                    <label for="lockerCellNumberCheckbox">–ü—Ä–æ–Ω—É–º–µ—Ä–æ–≤–∞—Ç—å –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é —Å–ª–µ–¥—É—é—â–∏–µ
                      —è—á–µ–π–∫–∏</label>
                  </div>
                  <button id="dialogLockerCellsSave">OK</button>
                </form>
              </div>
            </dialog>
            <form>
              <fieldset>
                <legend>–ù–æ–º–µ—Ä–∞ —è—á–µ–µ–∫</legend>

                <div class="grid-container" id="locker-grid">
                </div>
              </fieldset>
            </form>
          </div>
          <div id="conditionerForm">
            <form>
              <fieldset>
                <legend>–í–ö–õ/–í–´–ö–õ</legend>

                <div class="form-group form-group_block">
                  <label for="conditionerOnInput">–ó–Ω–∞—á–µ–Ω–∏–µ –í–ö–õ</label>
                  <input id="conditionerOnInput" data-prop="On" type="number">
                </div>

                <div class="form-group form-group_block">
                  <label for="conditionerOffInput">–ó–Ω–∞—á–µ–Ω–∏–µ –í–´–ö–õ</label>
                  <input id="conditionerOffInput" data-prop="Off" type="number">
                </div>
              </fieldset>

              <fieldset>
                <legend>–†–µ–∂–∏–º—ã</legend>

                <div class="form-group form-group_block">
                  <label for="conditionerOffModeInput">–í—ã–∫–ª—é—á–µ–Ω</label>
                  <input id="conditionerOffModeInput" data-prop="OffMode" type="number">
                </div>

                <div class="form-group form-group_block">
                  <label for="conditionerCoolingModeInput">–û—Ö–ª–∞–∂–¥–µ–Ω–∏–µ</label>
                  <input id="conditionerCoolingModeInput" data-prop="CoolingMode" type="number">
                </div>

                <div class="form-group form-group_block">
                  <label for="conditionerHeatingModeInput">–û–±–æ–≥—Ä–µ–≤</label>
                  <input id="conditionerHeatingModeInput" data-prop="HeatingMode" type="number">
                </div>

                <div class="form-group form-group_block">
                  <label for="conditionerVentilationModeInput">–í–µ–Ω—Ç–∏–ª—è—Ü–∏—è</label>
                  <input id="conditionerVentilationModeInput" data-prop="VentilationMode" type="number">
                </div>

                <div class="form-group form-group_block">
                  <label for="conditionerDryingModeInput">–û—Å—É—à–µ–Ω–∏–µ</label>
                  <input id="conditionerDryingModeInput" data-prop="DryingMode" type="number">
                </div>

                <div class="form-group form-group_block">
                  <label for="conditionerAutoModeInput">–ê–≤—Ç–æ</label>
                  <input id="conditionerAutoModeInput" data-prop="AutoMode" type="number">
                </div>

              </fieldset>

              <fieldset>
                <legend>–°–∫–æ—Ä–æ—Å—Ç–∏</legend>

                <div class="form-group form-group_block">
                  <label for="conditionerStopVelocityInput">–°—Ç–æ–ø</label>
                  <input id="conditionerStopVelocityInput" data-prop="StopVelocity" type="number">
                </div>

                <div class="form-group form-group_block">
                  <label for="conditionerMinimalVelocityInput">–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è</label>
                  <input id="conditionerMinimalVelocityInput" data-prop="MinimalVelocity" type="number">
                </div>

                <div class="form-group form-group_block">
                  <label for="conditionerMiddleVelocityInput">–°—Ä–µ–¥–Ω—è—è</label>
                  <input id="conditionerMiddleVelocityInput" data-prop="MiddleVelocity" type="number">
                </div>

                <div class="form-group form-group_block">
                  <label for="conditionerHighVelocityInput">–í—ã—Å–æ–∫–∞—è</label>
                  <input id="conditionerHighVelocityInput" data-prop="HighVelocity" type="number">
                </div>

                <div class="form-group form-group_block">
                  <label for="conditionerAutoVelocityInput">–ê–≤—Ç–æ</label>
                  <input id="conditionerAutoVelocityInput" data-prop="AutoVelocity" type="number">
                </div>

              </fieldset>

            </form>
            <button id="conditionerSave">OK</button>
          </div>
          <div id="luminairesGroupBlock">
            <form id="luminairesGroupForm">
              <div class="form-group">
                <input id="luminairesGroupCheckBox" type="checkbox">
                <label for="luminairesGroupCheckBox">–ì—Ä—É–ø–ø–∞ —Å–≤–µ—Ç–∏–ª—å–Ω–∏–∫–æ–≤</label>
              </div>
            </form>

            <div id="luminairesGroupListBlock">
              –°–≤–µ—Ç–∏–ª—å–Ω–∏–∫–∏:
              <div class="luminaires" id="luminairesList">
                <div class="luminaire"></div>
              </div>
            </div>



          </div>
        </div>
      </div>
      <div class="setup" id="zoneFormTemplate">
        <div class="setup__device" id="setupZone">
<!--          <svg height="24" viewBox="0 0 24 24"-->
<!--               width="24"-->
<!--               xmlns="http://www.w3.org/2000/svg">-->
<!--            <use xlink:href="#locker"></use>-->
<!--          </svg>-->
          <span id="zoneInfo" style="font-weight: bold;"></span>
        </div>
        <div class="setup__form">
          <form id="zoneForm">
            <div class="form-group">
              <input id="zoneCheckBox" type="checkbox">
              <label for="zoneCheckBox">–ö–æ–Ω—Ç—É—Ä –∑–æ–Ω—ã</label>
            </div>
          </form>
        </div>
      </div>
    </div>
    <!--      <div class="grid__cell grid__cell_width-50">2</div>-->
  </div>
</div>
<div class="d-none" id="config-to-settings">
  <h2>–ü—Ä–µ–æ–±—Ä–∞–∑—É–π—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –ø–ª–∞–Ω–∞ (json) –≤ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h2>

  <label for="planConfiguration">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∫–æ–Ω—Ñ–∏–≥—Ä–∞—Ü–∏—é –ø–ª–∞–Ω–∞ (json):</label>

  <input accept=".json"
         id="planConfiguration" name="configuration"
         type="file"/>
  <div id="preview"></div>
</div>

<template id="setupDeviceTemplate">
  <svg height="24" viewBox="0 0 24 24"
       width="24"
       xmlns="http://www.w3.org/2000/svg">
    <use xlink:href="#"></use>
  </svg>
  –õ–æ–∫–µ—Ä <!--<span id="deviceInfo" style="font-weight: bold;"></span>-->
</template>

<svg style="position:fixed;left:-999em">
  <symbol id="locker">
    <rect fill="#30333B" height="22" rx="3" width="22" x="1" y="1"/>
    <rect height="22" rx="3" stroke="#fff" stroke-width="2" width="22" x="1" y="1"/>
    <path
      d="M8.667 3.667h6.666A1.666 1.666 0 0 1 17 5.332v13.334a1.666 1.666 0 0 1-1.667 1.666H8.667A1.667 1.667 0 0 1 7 18.667V5.332a1.667 1.667 0 0 1 1.667-1.667Zm0 1.666v13.334h6.666V5.332H8.667Zm1.666 7.5H12v3.333h-1.667v-3.333Zm0-5.833h3.334v1.25h-3.334V7Zm0 2.5h3.334v1.25h-3.334V9.5Z"
      fill="#fff"/>
  </symbol>
</svg>

<script src="./scripts/jszip.min.js"></script>
<script>

  let lockerCellsQuantityDefault = 16;
  let nodeSelected;


  const once = {
    once: true,
  };


  async function fileToJSON(file) {
    return new Promise((resolve, reject) => {
      const fileReader = new FileReader()
      fileReader.onload = event => resolve(JSON.parse(event.target.result))
      fileReader.onerror = error => reject(error)
      fileReader.readAsText(file)
    })
  }

  function generateSettings(config) {
    console.log('generateSettings');
    let settings = {};
    if (config) {
      settings = JSON.parse(JSON.stringify(config));

      for (const zone of Object.keys(settings)) {
        if (settings[zone].hasOwnProperty('items')) {
          delete settings[zone].item_type;
          delete settings[zone].title;
          settings[zone] = Object.assign(settings[zone], settings[zone].items)
          delete settings[zone].items;

          for (const device of Object.keys(settings[zone])) {
            delete settings[zone][device].param_type;
            delete settings[zone][device].item_type;
            delete settings[zone][device].items;
            delete settings[zone][device].title;
            delete settings[zone][device].custom_data?.template;
          }
        }
      }
    }

    return settings
  }

  function renderSetupForm(node, quantity) {
    console.log('renderSetupForm runs: ');
    console.log('renderSetupForm node: ', node);

    nodeSelected = node;

    // if ("content" in document.createElement("template")) {
    // }
    const deviceFormTemplate = document.getElementById('deviceFormTemplate');
    if (deviceFormTemplate) {
      deviceFormTemplate.style.display = 'none';
    }



    if ( deviceFormTemplate && node ) {
      const deviceInfo = document.getElementById('deviceInfo');
      if (deviceInfo) {
        deviceInfo.innerText = `–ù–∞–∑–≤–∞–Ω–∏–µ: ${node.name}, –∫–æ–º–ø–æ–Ω–µ–Ω—Ç: ${node.mainComponentName}`;
      }
      // console.log('node: ', node);
      // console.log('node.mainComponentName: ', node.mainComponentName);
      const lockerForm = document.getElementById('lockerForm');
      const conditionerForm = document.getElementById('conditionerForm');
      const zoneFormTemplate =  document.getElementById('zoneFormTemplate');
      const zoneCheckBoxEl = document.getElementById('zoneCheckBox');
      zoneCheckBoxEl.removeEventListener("change", handleZoneCheckBoxEvent);
      const luminairesGroupCheckBoxEl = document.getElementById('luminairesGroupCheckBox');
      const luminairesGroupBlock = document.getElementById('luminairesGroupBlock');

      zoneFormTemplate.style.display = 'none';
      conditionerForm.style.display = 'none';
      luminairesGroupBlock.style.display = 'none';
      lockerForm.style.display = 'none';

      // –ò–Ω—Å—Ç–∞–Ω—Å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
      if (node.type === 'INSTANCE') {
        console.log('instance');
        switch (node.mainComponentName) {
          case 'locker':
            deviceFormTemplate.style.display = 'block';
            lockerForm.style.display = 'block';
            if ("content" in document.createElement("template")) {
              let setupDeviceTemplate = document.getElementById('setupDeviceTemplate');
              let setupDevice = document.getElementById('setupDevice');
              let setupDeviceClone = setupDeviceTemplate.content.cloneNode(true);
              let setupDeviceCloneIcon = setupDeviceClone.querySelector('use');
              setupDeviceCloneIcon.setAttribute('xlink:href', 'locker1');

            }
            const lockerCellsNumbersDefault = Array.from({length: quantity}, (_, i) => i + 1); //[1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16];

            // Get locker cells number from plugin data. If empty set numbers to default 1-16.
            let cells_numbers = [];

            if (node.pluginData.cells_numbers) {
              cells_numbers = JSON.parse(node.pluginData.cells_numbers);
            } else {
              cells_numbers = lockerCellsNumbersDefault;
            }

            const gridEl = document.getElementById('locker-grid');

            gridEl.innerHTML = '';

            for (let i = 0; i < cells_numbers.length; i++) {
              const gridItemTemplate = document.createElement('div');
              gridItemTemplate.classList.add('grid-item', 'grid-item_locker-cell');
              gridItemTemplate.innerHTML = `<div class="locker-index">${i + 1}</div>${cells_numbers[i]}`;
              gridItemTemplate.addEventListener("click", () => {
                openCellEditModal(cells_numbers[i], i, node);
              });

              gridEl.appendChild(gridItemTemplate);
            }
            break;
          case 'conditioner':
            deviceFormTemplate.style.display = 'block';
            conditionerForm.style.display = 'block';

            let conditionerDefaultSettings = {
              'On': '',
              'Off': '',
              'OffMode': '',
              'HeatingMode': '',
              'VentilationMode': '',
              'CoolingMode': '',
              'DryingMode': '',
              'AutoMode': '',
              'StopVelocity': '',
              'MinimalVelocity': '',
              'MiddleVelocity': '',
              'HighVelocity': '',
              'AutoVelocity': ''
            };

            let conditionerSettings;
            if (node.pluginData.settings) {
              conditionerSettings = JSON.parse(node.pluginData.settings);
            } else {
              conditionerSettings = conditionerDefaultSettings;
            }

            const conditionerSaveBtn = document.getElementById('conditionerSave');
            conditionerSaveBtn.replaceWith(conditionerSaveBtn.cloneNode(true));
            const conditionerSaveBtnClone = document.getElementById('conditionerSave');

            const inputList = document.querySelectorAll("input[id^='conditioner']");
            for (let i = 0; i <= inputList.length; ++i) {
              if (inputList[i]) {

                const prop = inputList[i].dataset.prop;
                inputList[i].value = parseFloat(conditionerSettings[prop]);
              }
            }


            // conditionerSaveBtn.addEventListener('click', handleConditionerBtnSaveEvent(node, inputList, conditionerSettings));
            conditionerSaveBtnClone.addEventListener('click', () => {

              for (let i = 0; i < inputList.length; ++i) {
                if (inputList[i]) {
                  const prop = inputList[i].dataset.prop;
                  if (isNaN(parseFloat(inputList[i].value))) {
                    conditionerSettings[prop] = ''
                  } else {
                    conditionerSettings[prop] = parseFloat(inputList[i].value);
                  }
                }
              }
              // renderSetupForm(node, lockerCellsQuantityDefault);
              parent.postMessage({
                pluginMessage: {
                  command: 'setConditionerData',
                  data: conditionerSettings,
                  nodeId: node.id
                }
              }, '*')
            }, false);

            break;

          default:
            break;
        }
      }
      // –ö–æ–Ω—Ç—É—Ä –∑–æ–Ω—ã
      else if (
        node.parentType === 'GROUP' && (
        node.type === 'VECTOR' ||
        node.type === 'ELLIPSE' ||
        node.type === 'LINE' ||
        node.type === 'POLYGON' ||
        node.type === 'RECTANGLE' ||
        node.type === 'STAR' ||
        node.type === 'BOOLEAN_OPERATION')) {

        console.log('vector');
        deviceFormTemplate.style.display = 'none';
        zoneFormTemplate.style.display = 'block';
        // let isZonePath = false;
        if (node.pluginData.hasOwnProperty('isZonePath')) {
          zoneCheckBoxEl.checked = false;
        }
        node.pluginData.isZonePath === 'true' ? zoneCheckBoxEl.checked = true : zoneCheckBoxEl.checked = false;
        zoneCheckBoxEl.replaceWith(zoneCheckBoxEl.cloneNode(true));
        const zoneCheckBoxElClone = document.getElementById('zoneCheckBox');
        // if (node.pluginData.isZonePath === 'true') {
        //   isZonePath = true;
        // } else {
        //   isZonePath = false;
        // }

        zoneCheckBoxElClone.addEventListener('change', handleZoneCheckBoxEvent(node, node.pluginData.isZonePath));
      }

      // –ì—Ä—É–ø–ø—ã —Å–≤–µ—Ç–∏–ª—å–Ω–∏–∫–æ–≤
      else if ( node.type === 'FRAME' &&
        node.parentType === 'GROUP' ) {
        deviceFormTemplate.style.display = 'block';
        luminairesGroupBlock.style.display = 'block';
        const deviceInfo = document.getElementById('deviceInfo');
        if (deviceInfo) {
          deviceInfo.innerText = `–ù–∞–∑–≤–∞–Ω–∏–µ: ${node.name}, —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: –ì—Ä—É–ø–ø–∞ —Å–≤–µ—Ç–∏–ª—å–Ω–∏–∫–æ–≤`;
        }

        if (!node.pluginData.hasOwnProperty('deviceType')) {
          node.pluginData.deviceType = '';
        }
        node.pluginData.deviceType === 'luminairesGroup' ? luminairesGroupCheckBoxEl.checked = true : luminairesGroupCheckBoxEl.checked = false;

        // if (node.pluginData.isZonePath === 'true') {
        //   isZonePath = true;
        // } else {
        //   isZonePath = false;
        // }
        luminairesGroupCheckBoxEl.replaceWith(luminairesGroupCheckBoxEl.cloneNode(true));
        const luminairesGroupCheckBoxElClone = document.getElementById('luminairesGroupCheckBox');
        // luminairesGroupCheckBoxEl.removeEventListener('change', handleLuminairesGroupCheckBoxEvent, false);
        // debugger;
        // luminairesGroupCheckBoxElReplaced.addEventListener('change', handleLuminairesGroupCheckBoxEvent.bind(null, node));

        luminairesGroupCheckBoxElClone.addEventListener('change', handleLuminairesGroupCheckBoxEvent(node), false);
        const luminairesGroupFormEl = document.getElementById('luminairesGroupForm');
        const luminairesGroupListBlockEl = document.getElementById('luminairesGroupListBlock');
        const luminairesListEl = document.getElementById('luminairesList');
        luminairesListEl.innerHTML = '';
        luminairesGroupListBlockEl.style.display = 'none';


        node.children.length > 0 ? luminairesGroupListBlockEl.style.display = 'block' : 'none';
        for (let i = 0; i < node.children.length; ++i) {
          if (node.children[i]) {
            const luminaireEl = document.createElement('div');
            luminaireEl.innerText = node.children[i].name;
            luminairesListEl.appendChild(luminaireEl);
          }
        }

      }
    }
  }

  // TODO: use named event fn instead on anonymous, add removeEventListeter
  const handleConditionerBtnSaveEvent = (node, inputList, conditionerSettings) => {
    return function (event) {

      for (let i = 0; i < inputList.length; ++i) {
        if (inputList[i]) {
          const prop = inputList[i].dataset.prop;
          if (isNaN(parseFloat(inputList[i].value))) {
            conditionerSettings[prop] = ''
          } else {
            conditionerSettings[prop] = parseFloat(inputList[i].value);
          }
        }
      }

      // renderSetupForm(node, lockerCellsQuantityDefault);
      parent.postMessage({
        pluginMessage: {
          command: 'setConditionerData',
          data: conditionerSettings,
          nodeId: node.id
        }
      }, '*')
    }
  }

  const handleZoneCheckBoxEvent = (node) => {
    return function (event) {
      let isZonePath = false;
      // This function will be executed when the checkbox's state changes
      if (node) {
        if (event.target.checked) {
          isZonePath = true;
        } else {
          isZonePath = false;
        }

        parent.postMessage({
          pluginMessage: {
            command: 'setZoneData',
            data: isZonePath,
            nodeId: node.id
          }
        }, '*')
      }
    }
  }

  // function handleLuminairesGroupCheckBoxEvent(node, event) {
  const handleLuminairesGroupCheckBoxEvent = (node) => {
    return function (event) {
      // event.stopImmediatePropagation();
      // This function will be executed when the checkbox's state changes
      let deviceType = '';
      if (node) {
        if (event.target.checked) {
          deviceType = 'luminairesGroup';
        } else {
          deviceType = '';
        }

        parent.postMessage({
          pluginMessage: {
            command: 'setLuminairesGroupData',
            data: deviceType,
            nodeId: node.id
          }
        }, '*');

        // renderSetupForm(node, lockerCellsQuantityDefault);
      }
    }
  }


  // saveData() {
  //
  // }

  function openCellEditModal(item, index, node) {
    const cellEditDialog = document.getElementById('cellEditDialog');
    const cellDialogTitle = document.getElementById('dialogTitle')
    const cellIndex = document.getElementById('cellIndex');
    const lockerCellNumberInput = document.getElementById('lockerCellNumberInput');
    const saveBtn = document.getElementById('dialogLockerCellsSave');
    const closeBtn = document.getElementById('dialogCloseBtn');
    const checkEl = document.getElementById('lockerCellNumberCheckbox');


    cellDialogTitle.innerHTML = `<div id="dialogheader">–õ–æ–∫–µ—Ä ${node.name}, —è—á–µ–π–∫–∞ <span id="cellIndex">${index + 1}</span></div>`;

    cellEditDialog.addEventListener('click', function (event) {
      const rect = cellEditDialog.getBoundingClientRect();
      const isInDialog = (rect.top <= event.clientY && event.clientY <= rect.top + rect.height &&
        rect.left <= event.clientX && event.clientX <= rect.left + rect.width);
      if (!isInDialog) {
        cellEditDialog.close();
      }
    });
    // cellIndex.innerText = index + 1;
    lockerCellNumberInput.value = item;

    closeBtn.addEventListener("click", () => {
      cellEditDialog.close("Cancel editing");
    });

    saveBtn.addEventListener("click", () => {
      const cells_numbers = JSON.parse(node.pluginData.cells_numbers);
      if (checkEl.checked) {
        cells_numbers[index] = parseInt(lockerCellNumberInput.value);
        for (let i = 0; i < cells_numbers.length; i++) {
          if (i > index) {
            cells_numbers[i] = cells_numbers[i - 1] + 1;
          }

        }
      } else {
        console.log(false)
        cells_numbers[index] = parseInt(lockerCellNumberInput.value);
      }

      node.pluginData.cells_numbers = JSON.stringify(cells_numbers);
      // node.pluginData.JSON.parse[cells_numbers[index] = lockerCellNumberInput.value;
      renderSetupForm(node, lockerCellsQuantityDefault);
      parent.postMessage({
        pluginMessage: {
          command: 'setLockerData',
          data: cells_numbers,
          nodeId: node.id
        }
      }, '*')
    }, once);

    cellEditDialog.showModal();
  }

  function saveLockerCellsNumbers(item) {

  }

  onmessage = async (event) => {
    let message = event.data.pluginMessage;

    // if (message.command === "getSelectedNode") {
    //   console.log('getSelectedNode');
    //   console.log('message.pluginData from getSelectedNode: ', message.nodes);
    //
    //   if ( message.nodes.length === 1 ) {
    //     console.log('message.pluginData: ', message.pluginData[0]);
    //     renderSetupForm(message.nodes[0], 16);
    //   } else {
    //     parent.postMessage({
    //       pluginMessage: {
    //         notification: '–í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –∏–∑ –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤'
    //       }
    //     }, '*');
    //     // figma.notify('–í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –∏–∑ –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤');
    //     // figma.closePlugin();
    //   }
    //
    //
    // }

    if (message.command === "setup") {
      const formEl = document.getElementById('setup');
      formEl.classList.remove('d-none');
      lockerCellsQuantityDefault = message.lockerCellsQuantityDefault
      renderSetupForm(message.nodes[0], message.lockerCellsQuantityDefault);
    }

    if (message.command === "export") {
      return new Promise(resolve => {

        const config = message.data.data.configuration;
        const settings = message.data.data.settings;
        const svg = message.data.data.svg;

        let zip = new JSZip();
        zip.file('plan_configuration.json', config, {base64: false});
        zip.file('plan_settings.txt', settings, {base64: false});
        zip.file('plan_svg.svg', svg, {base64: false});


        zip.generateAsync({type: 'blob'})
          .then((blob) => {
            const blobURL = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.className = 'button button--primary';
            link.href = blobURL;
            link.download = message.data.filename
            link.click();
            resolve();
          });
      })
        .then(() => {
          parent.postMessage({
            pluginMessage: {
              command: 'closePlugin',
              notification: 'üéâ Plan configuration export succesfull!'
            }
          }, '*');
        }).catch(error => console.log(error));
    }

    if (message.command === "configToSettings") {
      let config = {};
      const formEl = document.getElementById('config-to-settings');
      formEl.classList.remove('d-none');
      return new Promise(resolve => {
        function onChange(event) {
          const reader = new FileReader();
          reader.onload = onReaderLoad;
          reader.readAsText(event.target.files[0]);
        }

        function onReaderLoad(event) {
          const obj = JSON.parse(event.target.result);
          resolve(obj);
        }

        document.getElementById('planConfiguration').addEventListener('change', onChange);
      })
        .then((config) => generateSettings(config))
        .then((settings) => {
          const previewEl = document.getElementById('preview');

          // add button that copy Settings
          let btnCopySettinsEl = document.createElement('button');
          btnCopySettinsEl.id = 'copySettingsBtn';
          btnCopySettinsEl.innerText = 'Copy Settings';
          btnCopySettinsEl.style.margin = '16px 0 8px 0';
          previewEl.appendChild(btnCopySettinsEl);

          // add textarea with Settings
          const textareaWithSetting = document.createElement('textarea');
          textareaWithSetting.value = JSON.stringify(settings, null, 2);
          textareaWithSetting.style.cssText += 'width: 100%; height: 270px; resize: none';
          previewEl.appendChild(textareaWithSetting);

          // select textarea text and copy to clipboard
          btnCopySettinsEl.onclick = function () {
            textareaWithSetting.select();
            document.execCommand('copy');
          }
        })
        .then(() => {
          parent.postMessage({
            pluginMessage: {
              notification: 'üéâ Plan settings ready!'
            }
          }, '*')
        });
    }

    // open help page
    if (message.command === "help") {
      window.open('https://github.com/inspark/figma_plugin_2Dplan')
      parent.postMessage({
        pluginMessage: {
          command: 'closePlugin'
        }
      }, '*')
    }

    if (message.command === undefined) {

      let svgData = {};
      const parser = new DOMParser();
      const exportedData = message.exportedData;
      const svgDomNode = parser.parseFromString(message.svg, "image/svg+xml");

      for (const zoneId of Object.keys(exportedData)) {
        const zoneEl = svgDomNode.getElementById(zoneId);
        if (zoneEl?.id.startsWith('zone_', 0)) {
          const zonePathEl = zoneEl.getElementsByTagName('path')[0];

          svgData[zoneId] = {};
          svgData[zoneId].devices = {};

          if (zonePathEl) {
            svgData[zoneId].path = zonePathEl.getAttribute('d');
            svgData[zoneId].id = zonePathEl.id;
          }

          for (const deviceId of Object.keys(exportedData[zoneId])) {

            if (deviceId) {
              const deviceName = exportedData[zoneId][deviceId]?.name;
              const deviceEl = svgDomNode.getElementById(deviceName);

              if (deviceEl) {
                switch (exportedData[zoneId][deviceId].component) {
                  case 'luminairesGroup':
                    // const luminairesGroupEl = deviceEl.getElementsByTagName('rect')[0];
                    svgData[zoneId].devices[deviceId] = {
                      id: exportedData[zoneId][deviceId].component + '_' + deviceId
                    };
                    // for (const luminaireId of Object.keys(exportedData[zoneId][deviceId])) {
                    //   console.log('luminaireId: ', luminaireId);
                    svgData[zoneId].devices[deviceId].items = {};
                    for (const luminaire of deviceEl.children) {
                      if (luminaire.tagName === 'path') {
                        const luminaireId = luminaire.getAttribute('id');

                        svgData[zoneId].devices[deviceId].items[luminaireId] = {
                          id: luminaireId,
                          path: luminaire.getAttribute('d'),
                        };

                      } else {
                        console.error('Luminaire tag name should be a path. Current type: ' + luminaire.tagName);
                      }
                    }

                    break;
                  case 'rectangle':
                    const rectEl = deviceEl.getElementsByTagName('rect')[0];
                    if (rectEl) {
                      svgData[zoneId].devices[deviceId] = {
                        id: exportedData[zoneId][deviceId].component + '_' + deviceEl.id,
                        x: rectEl.getAttribute('x'),
                        y: rectEl.getAttribute('y'),
                        width: rectEl.getAttribute('width'),
                        height: rectEl.getAttribute('height'),
                        rx: rectEl.getAttribute('rx'),
                        ry: rectEl.getAttribute('ry')
                      };
                    }
                    break;

                  case 'text':
                    const textEl = deviceEl.getElementsByTagName('text')[0];
                    const tspanEl = deviceEl.getElementsByTagName('tspan')[0];
                    if (textEl && tspanEl) {
                      svgData[zoneId].devices[deviceId] = {
                        id: exportedData[zoneId][deviceId].component + '_' + deviceEl.id,
                        style: textEl.getAttribute('style'),
                        'font-family': textEl.getAttribute('font-family'),
                        'font-size': textEl.getAttribute('font-size'),
                        'font-weight': textEl.getAttribute('font-weight'),
                        'letter-spacing': textEl.getAttribute('letter-spacing'),
                        x: tspanEl.getAttribute('x'),
                        y: tspanEl.getAttribute('y')
                      };
                    }
                    break;

                  default:
                    console.log('Unknown component in svg.');
                }
              }

            }

          }
        }

      }
      console.log('svgData before add devices: ', svgData);

      parent.postMessage({
        pluginMessage: {
          command: 'setSVGData',
          data: svgData
        }
      }, '*')

    }
  }


</script>
</body>


