<link rel="stylesheet" href="https://static.figma.com/api/figma-extension-api-0.0.1.css">
<h2>–ü—Ä–µ–æ–±—Ä–∞–∑—É–π—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –ø–ª–∞–Ω–∞ (json) –≤ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h2>

<label for="planConfiguration">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∫–æ–Ω—Ñ–∏–≥—Ä–∞—Ü–∏—é –ø–ª–∞–Ω–∞ (json):</label>

<input type="file"
       id="planConfiguration" name="configuration"
       accept=".json"/>
<div id="preview"></div>

<script src="./scripts/jszip.min.js"></script>
<script>

  async function fileToJSON(file) {
    return new Promise((resolve, reject) => {
      const fileReader = new FileReader()
      fileReader.onload = event => resolve(JSON.parse(event.target.result))
      fileReader.onerror = error => reject(error)
      fileReader.readAsText(file)
    })
  }

  function generateSettings(config) {
    let settings = {};
    if (config){
      settings = JSON.parse(JSON.stringify(config));
      console.log('settins in generateSettings: ', settings);

      for (const zone of Object.keys(settings)) {
        if (settings[zone].hasOwnProperty('items')) {
          delete settings[zone].item_type;
          delete settings[zone].title;
          settings[zone] = Object.assign(settings[zone], settings[zone].items)
          delete settings[zone].items;

          for (const device of Object.keys(settings[zone])) {
            delete settings[zone][device].param_type;
            delete settings[zone][device].item_type;
            delete settings[zone][device].items;
            delete settings[zone][device].title;
            delete settings[zone][device].custom_data?.template;
          }
        }
      }
    }

    return settings
  };

  onmessage = async (event) => {
    let message = event.data.pluginMessage;
    if (message.command === "export") {
      return new Promise(resolve => {

        var config = message.data.data.configuration;
        var settings = message.data.data.settings;

        let zip = new JSZip();
        zip.file('plan_configuration.json', config, {base64: false});
        zip.file('plan_settings.txt', settings, {base64: false});


        zip.generateAsync({ type: 'blob' })
        .then((blob) => {
          const blobURL = window.URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.className = 'button button--primary';
          link.href = blobURL;
          link.download = message.data.filename
          link.click();
          resolve();
        });
      })
      .then(() => {
        parent.postMessage({
        pluginMessage: {
          command: 'closePlugin',
          notification: 'üéâ Plan configuration export succesfull!'
        }
      }, '*')
      });
    }

    if (message.command === "configToSettings") {
      let config = {};
      return new Promise(resolve => {
        function onChange(event) {
          var reader = new FileReader();
          reader.onload = onReaderLoad;
          reader.readAsText(event.target.files[0]);
        }

        function onReaderLoad(event){
          let obj = JSON.parse(event.target.result);
          resolve(obj);
        }

        document.getElementById('planConfiguration').addEventListener('change', onChange);
      })
      .then((config) => generateSettings(config))
      .then((settings) => {
        const previewEl = document.getElementById('preview');

        // add button that copy Settings
        var btnCopySettinsEl = document.createElement('button');
        btnCopySettinsEl.id = 'copySettingsBtn';
        btnCopySettinsEl.innerText = 'Copy Settings';
        btnCopySettinsEl.style.margin = '16px 0 8px 0';
        previewEl.appendChild(btnCopySettinsEl);

        // add textarea with Settings
        const textareaWithSetting = document.createElement('textarea');
        textareaWithSetting.value = JSON.stringify(settings, null, 2);
        textareaWithSetting.style.cssText += 'width: 100%; height: 270px; resize: none';
        previewEl.appendChild(textareaWithSetting);

        // select textarea text and copy to clipboard
        btnCopySettinsEl.onclick = function() {
          textareaWithSetting.select();
          document.execCommand('copy');
        }
      })
      .then(() => {
        parent.postMessage({
        pluginMessage: {
          notification: 'üéâ Plan settings ready!'
        }
      }, '*')
      });
    }

    // open help page
    if (message.command === "help") {
      window.open('https://github.com/inspark/figma_plugin_2Dplan')
      parent.postMessage({
        pluginMessage: {
          command: 'closePlugin'
        }
      }, '*')
    }
  }


  </script>
